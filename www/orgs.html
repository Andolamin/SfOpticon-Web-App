<?php
    $root = 'orgs.html';
    include_once('functions.php');
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Orgs - PS SfOpticon</title>
    <?php include_once(dirname(__FILE__) . '/head.html'); ?>
</head>
<body>
    <div id="wrapper">
        <?php include_once(dirname(__FILE__) . '/header.html'); ?>

        <div id="page-wrapper">
            <div class="alert alert-success alert-dismissable">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <strong>Good to go!</strong> This page is fully attached to data.
            </div>
            <?php
                $attemptedToSaveCredentials = false;
                $savedCredentials = false;
                if (isset($_POST['email']) &&
                    isset($_POST['password']) &&
                    isset($_POST['token']) &&
                    isset($_POST['environment'])) {
                    $attemptedToSaveCredentials = true;
                    try {
                        $db_con = connectDBi();
                    } catch (Exception $e) {
                        if ($e->getMessage() == "100") {
                            $error = mysql_error();
                            die("Error connecting to the database");
                        } else if ($e->getMessage() == "101") {
                            $error = mysql_error();
                            die("Error selecting the database");
                        }
                    }
                    $dbStr = "UPDATE `environmentCredential` SET `email`='" . $_POST['email'] . "'," .
                             "`password`=AES_ENCRYPT('" . $_POST['password'] . "', '" . $_SESSION['sfToken'] . "'), " .
                             "`token`=AES_ENCRYPT('" . $_POST['token'] . "', '" . $_SESSION['sfToken'] . "') " .
                             "WHERE `environmentID` = " . $_POST['environment'] . " AND " .
                             "`userID`=(SELECT `ID` FROM `user` WHERE `auth_id` = '" . $_SESSION['sfUsername'] . "' LIMIT 1)";
                    $result = $db_con->query($dbStr);
                    if ($result) {
                        auditLog(null, 'Updated credentials for env <a href="org.html?orgId=' . $_POST['environment'] . '">#' . $_POST['environment']) . '</a>';
                        $savedCredentials = true;
                    }
                    $db_con->close();
                }
                if ($attemptedToSaveCredentials && $savedCredentials) {
            ?>
            <div class="alert alert-success alert-dismissable">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <strong>Awesome!</strong> Your updated credentials were saved successfully.
            </div>
            <?php
                } else if ($attemptedToSaveCredentials && !$savedCredentials) {
            ?>
            <div class="alert alert-danger alert-dismissable">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                <strong>Bummer!</strong> Your updated credentials weren't saved.
            </div>
            <?php
                }
                try {
                    $db_con = connectDBi();
                } catch (Exception $e) {
                    if ($e->getMessage() == "100") {
                        $error = mysql_error();
                        die("Error connecting to the database");
                    } else if ($e->getMessage() == "101") {
                        $error = mysql_error();
                        die("Error selecting the database");
                    }
                }

                $dbStr = ("SELECT `env`.`ID`, `env`.`name`, `env`.`production`, `env`.`location`, `env`.`locked`, " .
						"`credentials`.`email`, AES_DECRYPT(`credentials`.`password`, '" . $_SESSION['sfToken'] . "') as `password`, AES_DECRYPT(`credentials`.`token`, '" . $_SESSION['sfToken'] . "') as `token` " .
						"FROM `environment` as `env` JOIN (SELECT `environmentID`, `email`, `password`, `token` " .
						"FROM `environmentCredential` WHERE `userID` = (SELECT `ID` FROM `user` " .
						"WHERE `auth_id` = '" . $_SESSION['sfUsername'] . "' LIMIT 1)) as `credentials` ON `env`.`ID` = `credentials`.`environmentID`");
                $result = $db_con->query($dbStr);
                $numRows = $result->num_rows;
                $count = 1;
                while ($row = $result->fetch_assoc()) {
            ?>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <a href="org.html?orgId=<?php echo $row['ID']; ?>"><?php echo $row['name']; ?> <?php if ($row['production']) { echo '(production)'; } ?></a>
                    </h3>
                </div>
                <div class="panel-body">
                    <?php echo $row['location']; ?>
                </div>
                <div class="panel-footer" id="accordion">
                    <a data-toggle="collapse" href="#collapse<?php echo $count; ?>">
                        <div style="width: 100%; height:100%;">
                            Credentials
                        </div>
                    </a>
                </div>
                <form id="collapse<?php echo $count; ?>" class="list-group collapse" method="post">
                    <input type="hidden" name="environment" value="<?php echo $row['ID']; ?>">
                    <input type="text" name="email" class="form-control" placeholder="Username" value="<?php echo $row['email']; ?>">
                    <input type="password" name="password" class="form-control" placeholder="Password" value="<?php echo $row['password']; ?>">
                    <input type="text" name="token" class="form-control" placeholder="Security Token" value="<?php echo $row['token']; ?>">
                    <div class="btn-group btn-group-justified">
                        <div class="btn-group">
                            <input type="submit" value="Save" class="btn btn-success"></button>
                        </div>
                        <a class="btn btn-warning" data-toggle="collapse" href="#collapse1">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
            <?php
                    $count++;
                }
                $db_con->close();
            ?>
            <ul class="pager">
                <li class="next"><a href="org.html?orgId=-1">Add New</a></li>
            </ul>
        </div>
        <!-- /#page-wrapper -->
    </div>
    <!-- /#wrapper -->
</body>
</html>
